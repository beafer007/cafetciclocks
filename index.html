<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta http-equiv="refresh" content="21600">
  <title>World Clocks (Slide + Weather v6 - Rotate 3)</title>

  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0a1220;
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.72);
      --muted2: rgba(255,255,255,0.55);

      --pad: clamp(14px, 2vw, 28px);
      --radius: 24px;

      --city: clamp(18px, 2.2vw, 36px);
      --meta: clamp(14px, 1.6vw, 26px);

      /* digit sizing */
      --d-h: clamp(74px, 7.4vw, 126px);
      --d-w: calc(var(--d-h) * 0.72);
      --gap: clamp(8px, 1vw, 14px);
      --colon-w: clamp(14px, 1.6vw, 26px);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; }
    body{
      background: radial-gradient(900px 600px at 15% 15%, rgba(120,170,255,0.14), transparent 55%),
                  radial-gradient(900px 600px at 85% 85%, rgba(255,120,210,0.10), transparent 55%),
                  linear-gradient(160deg, var(--bg0), var(--bg1));
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
      position:relative;
    }
    body::before{
      content:"";
      position:absolute; inset:-20%;
      background: conic-gradient(from 180deg at 50% 50%,
        rgba(120,170,255,0.08),
        rgba(255,120,210,0.06),
        rgba(120,255,200,0.05),
        rgba(120,170,255,0.08)
      );
      filter: blur(60px);
      opacity: 0.45;
      animation: drift 22s linear infinite;
      pointer-events:none;
    }
    @keyframes drift{
      0%{ transform: translate3d(-2%,-2%,0) rotate(0deg); }
      50%{ transform: translate3d( 2%, 2%,0) rotate(180deg); }
      100%{ transform: translate3d(-2%,-2%,0) rotate(360deg); }
    }

    .wrap{
      position:relative;
      height:100%;
      display:flex;
      flex-direction:column;
      padding:var(--pad);
      gap:var(--pad);
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:16px;
      padding:6px 4px;
    }
    .title{
      font-weight:800;
      letter-spacing:.6px;
      font-size: clamp(18px, 2vw, 28px);
      display:flex;
      align-items:center;
      gap:10px;
      text-shadow: 0 8px 30px rgba(0,0,0,0.45);
    }
    .spark{
      width: 12px; height: 12px; border-radius:999px;
      background: rgba(140,255,190,0.9);
      box-shadow: 0 0 18px rgba(140,255,190,0.45);
    }
    .subtitle{
      font-size: clamp(12px, 1.3vw, 18px);
      color: var(--muted2);
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width: 10px; height: 10px; border-radius:999px;
      background: rgba(100,255,170,0.9);
      box-shadow: 0 0 18px rgba(100,255,170,0.35);
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform:scale(1); opacity:.9; }
      50%{ transform:scale(1.25); opacity:.65; }
    }

    .grid{
      flex:1;
      display:grid;
      gap: var(--pad);
      grid-template-columns: repeat(3, minmax(0, 1fr));
      transition: opacity 350ms ease;
    }
    .grid.fading{ opacity: 0; }

    @media (max-width: 1150px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .card{
      position:relative;
      border-radius: var(--radius);
      padding: calc(var(--pad) * 0.95);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      overflow:hidden;

      background:
        radial-gradient(800px 240px at 20% 0%, rgba(var(--accent),0.22), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 14px 40px rgba(0,0,0,0.40);
      backdrop-filter: blur(10px);
    }
    .card::before{
      content:"";
      position:absolute;
      inset: 18%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(var(--accent),0.18), transparent 70%);
      filter: blur(34px);
      opacity: 0.50;
      pointer-events:none;
    }

    .top, .mid, .meta{ position:relative; z-index:1; }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .city{
      font-size: var(--city);
      font-weight: 900;
      letter-spacing: 0.4px;
      display:flex;
      align-items:center;
      gap:12px;
      text-shadow: 0 10px 28px rgba(0,0,0,0.45);
      line-height:1.15;
    }
    .city span:last-child{ color: #ffd84a; }

    .badge{
      font-size: clamp(26px, 2.6vw, 42px);
      line-height:1;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.45));
    }

    .pill{
      border: 1px solid rgba(255,255,255,0.12);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.15);
      white-space: nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-size: var(--meta);
      font-variant-numeric: tabular-nums;
    }
    .sunmoon{
      width: 22px; height: 22px;
      display:inline-grid;
      place-items:center;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }

    .mid{ margin-top: 14px; }

    .row{
      display:flex;
      align-items:flex-end;
      gap: var(--gap);
      flex-wrap: nowrap;
    }

    .ampm{
      font-size: clamp(18px, 1.8vw, 26px);
      font-weight: 900;
      letter-spacing: 2px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.20);
      color: rgba(255,255,255,0.82);
      margin-left: 2px;
      margin-bottom: 8px;
      opacity: 0.92;
      text-shadow: 0 8px 18px rgba(0,0,0,0.45);
    }

    .colon{
      width: var(--colon-w);
      text-align:center;
      font-weight: 900;
      font-size: calc(var(--d-h) * 0.62);
      line-height:1;
      opacity: 0.92;
      text-shadow: 0 16px 30px rgba(0,0,0,0.55);
      transform: translateY(-8px);
    }
    .colon.blink{ animation: blink 1s steps(1,end) infinite; }
    @keyframes blink{ 50%{ opacity:0.35; } }

    .digitBox{
      width: var(--d-w);
      height: var(--d-h);
      border-radius: 14px;
      overflow:hidden;
      position:relative;
      background: rgba(0,0,0,0.70);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 18px 34px rgba(0,0,0,0.45);
    }
    .digitBox::after{
      content:"";
      position:absolute; left:-2px; right:-2px;
      top:50%;
      height:3px;
      background: rgba(0,0,0,0.78);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.12),
        inset 0 -1px 0 rgba(0,0,0,0.55);
      z-index:3;
    }
    .stack{
      position:absolute;
      left:0; top:0;
      width:100%;
      will-change: transform;
      transform: translate3d(0,0,0);
      transition: transform 280ms cubic-bezier(.2,.9,.2,1);
    }
    .cell{
      height: var(--d-h);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1, "lnum" 1;
      letter-spacing: 1px;
      font-size: calc(var(--d-h) * 0.72);
      line-height:1;
      text-rendering: geometricPrecision;
      -webkit-font-smoothing: antialiased;
      color: rgba(255,255,255,0.92);
      text-shadow: 0 18px 40px rgba(0,0,0,0.60);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(0,0,0,0.35));
    }

    /* Small (24h) time is yellow */
    .time12{
      margin-top: 14px;
      color: #ffd84a;
      font-size: clamp(28px, 2.8vw, 52px);
      font-weight: 950;
      letter-spacing: 0.8px;
      font-variant-numeric: tabular-nums;
      text-shadow: 0 14px 30px rgba(0,0,0,0.55);
    }

    .meta{
      margin-top: 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      font-variant-numeric: tabular-nums;
    }

    /* Unify date + weather typography */
    .pill,
    .wxPill {
      font-family: inherit;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.3px;
      font-weight: 900;
      color: rgba(255,255,255,0.85);
    }

    .wxPill{
      padding: 12px 16px;
      gap: 12px;
      font-size: clamp(18px, 1.9vw, 30px);
    }
    .wxIcon{ font-size: 1.35em; }
    .wxTemp{ font-weight: 950; color: rgba(255,255,255,0.94); }
    .wxNote{ color: rgba(255,255,255,0.72); font-weight: 850; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title"><span class="spark"></span>World Clocks</div>
      <div class="subtitle"><span class="dot"></span><span id="localNow">Loading‚Ä¶</span></div>
    </header>

    <main class="grid" id="grid"></main>
  </div>

  <script>
    const WEATHER_REFRESH_MS = 15 * 60 * 1000;

    // Rotation settings
    const PAGE_SIZE = 3;       // show 3 clocks at a time
    const ROTATE_MS = 15000;   // rotate every 15 seconds
    let pageIndex = 0;

    const CLOCKS = [
      { label: "Providenciales", tz: "America/Grand_Turk", flag:"üáπüá®", accent:"120,190,255", lat:21.6940, lon:-71.7979 },
      { label: "Miami", tz: "America/New_York", flag:"üá∫üá∏", accent:"255,120,170", lat:25.7617, lon:-80.1918 },
      { label: "Houston", tz: "America/Chicago", flag:"üá∫üá∏", accent:"140,255,190", lat:29.7604, lon:-95.3698 },
      { label: "Manila", tz: "Asia/Manila", flag:"üáµüá≠", accent:"120,255,230", lat:14.5995, lon:120.9842 },
      { label: "Santiago", tz: "America/Santo_Domingo", flag:"üá©üá¥", accent:"255,190,120", lat:19.4517, lon:-70.6970 },
      { label: "London", tz: "Europe/London", flag:"üá¨üáß", accent:"170,150,255", lat:51.5072, lon:-0.1276 },
      { label: "Toronto", tz: "America/Toronto", flag:"üá®üá¶", accent:"200,60,60", lat:43.6532, lon:-79.3832 },
      { label: "Kingston", tz: "America/Jamaica", flag:"üáØüá≤", accent:"255,120,120", lat:17.9712, lon:-76.7936 },
      { label: "Dubai", tz: "Asia/Dubai", flag:"üá¶üá™", accent:"255,180,80", lat:25.2048, lon:55.2708 },
    ];

    const grid = document.getElementById("grid");
    const localNow = document.getElementById("localNow");
    const digitState = new Map();

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[s]));
    }
    function cssEscape(s){
      if (window.CSS && CSS.escape) return CSS.escape(s);
      return String(s).replace(/["\\]/g, "\\$&");
    }

    function wxFromCode(code){
      const map = {
        0:["‚òÄÔ∏è","Clear"],1:["üå§Ô∏è","Mostly clear"],2:["‚õÖ","Partly cloudy"],3:["‚òÅÔ∏è","Overcast"],
        45:["üå´Ô∏è","Fog"],48:["üå´Ô∏è","Rime fog"],
        51:["üå¶Ô∏è","Drizzle"],53:["üå¶Ô∏è","Drizzle"],55:["üå¶Ô∏è","Drizzle"],
        56:["üåßÔ∏è","Freezing drizzle"],57:["üåßÔ∏è","Freezing drizzle"],
        61:["üåßÔ∏è","Rain"],63:["üåßÔ∏è","Rain"],65:["üåßÔ∏è","Heavy rain"],
        66:["üåßÔ∏è","Freezing rain"],67:["üåßÔ∏è","Freezing rain"],
        71:["üå®Ô∏è","Snow"],73:["üå®Ô∏è","Snow"],75:["üå®Ô∏è","Heavy snow"],77:["üå®Ô∏è","Snow grains"],
        80:["üå¶Ô∏è","Showers"],81:["üå¶Ô∏è","Showers"],82:["üåßÔ∏è","Heavy showers"],
        85:["üå®Ô∏è","Snow showers"],86:["üå®Ô∏è","Snow showers"],
        95:["‚õàÔ∏è","Thunderstorm"],96:["‚õàÔ∏è","Thunderstorm"],99:["‚õàÔ∏è","Thunderstorm"]
      };
      return map[code] || ["üå°Ô∏è","Weather"];
    }

    function time12Digits(tz){
      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: tz, hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: true
      }).formatToParts(new Date());

      const h = parts.find(p => p.type === "hour")?.value ?? "12";
      const m = parts.find(p => p.type === "minute")?.value ?? "00";
      const s = parts.find(p => p.type === "second")?.value ?? "00";
      return `${h}${m}${s}`;
    }

    function fmtTime24(tz){
      return new Intl.DateTimeFormat(undefined, {
        timeZone: tz, hour: "2-digit", minute: "2-digit", hour12: false
      }).format(new Date());
    }

    async function fetchWeather(lat, lon){
      const url =
        `https://api.open-meteo.com/v1/forecast` +
        `?latitude=${encodeURIComponent(lat)}` +
        `&longitude=${encodeURIComponent(lon)}` +
        `&current=temperature_2m,weather_code` +
        `&temperature_unit=fahrenheit` +
        `&timezone=auto`;

      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Weather fetch failed");
      const data = await res.json();
      return { temp: data?.current?.temperature_2m, code: data?.current?.weather_code };
    }

    async function refreshVisibleWeather(){
      const cards = Array.from(document.querySelectorAll("[data-card]"));
      const tasks = cards.map(async (card) => {
        const tz = card.getAttribute("data-tz");
        const label = card.getAttribute("data-label");
        const c = CLOCKS.find(x => x.tz === tz && x.label === label);
        if (!c) return;

        const el = card.querySelector(`[data-wx="${cssEscape(c.tz)}|${cssEscape(c.label)}"]`);
        if (!el) return;

        try{
          const wx = await fetchWeather(c.lat, c.lon);
          const [icon, labelText] = wxFromCode(wx.code);
          const t = (typeof wx.temp === "number") ? Math.round(wx.temp) : null;
          el.innerHTML = `<span class="wxIcon">${icon}</span>
                          <span class="wxTemp">${t !== null ? `${t}¬∞F` : "--"}</span>
                          <span class="wxNote">${escapeHtml(labelText)}</span>`;
        } catch {
          el.innerHTML = `<span class="wxIcon">üå°Ô∏è</span>
                          <span class="wxTemp">--</span>
                          <span class="wxNote">Weather</span>`;
        }
      });

      await Promise.allSettled(tasks);
    }

    function fmtDate(tz){
      return new Intl.DateTimeFormat(undefined, {
        timeZone: tz, weekday:"short", month:"short", day:"2-digit"
      }).format(new Date());
    }

    function ampmOnly(tz){
      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: tz, hour:"numeric", hour12:true
      }).formatToParts(new Date());
      return (parts.find(p=>p.type==="dayPeriod")?.value || "").toUpperCase();
    }

    function tzShortName(tz){
      const parts = new Intl.DateTimeFormat(undefined, {
        timeZone: tz, timeZoneName:"short"
      }).formatToParts(new Date());
      return parts.find(p=>p.type==="timeZoneName")?.value || tz;
    }

    function tzHour(tz){
      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: tz, hour:"2-digit", hour12:false
      }).formatToParts(new Date());
      return Number(parts.find(p=>p.type==="hour")?.value ?? "0");
    }

    function sunOrMoonEmoji(hour){
      return (hour >= 6 && hour < 18) ? "‚òÄÔ∏è" : "üåô";
    }

    function digitTemplate(tz, pos){
      const key = `${tz}|${pos}`;
      digitState.set(key, 0);
      const cells = Array.from({length:10}, (_,i)=>`<div class="cell">${i}</div>`).join("");
      return `
        <div class="digitBox" data-tz="${escapeHtml(tz)}" data-pos="${pos}">
          <div class="stack" data-stack>${cells}</div>
        </div>
      `;
    }

    function buildPage(){
      grid.innerHTML = "";
      digitState.clear();

      const totalPages = Math.ceil(CLOCKS.length / PAGE_SIZE);
      if (pageIndex >= totalPages) pageIndex = 0;

      const start = pageIndex * PAGE_SIZE;
      const slice = CLOCKS.slice(start, start + PAGE_SIZE);

      for (const c of slice){
        const tzEsc = escapeHtml(c.tz);
        const card = document.createElement("section");
        card.className = "card";
        card.style.setProperty("--accent", c.accent);
        card.setAttribute("data-card", "1");
        card.setAttribute("data-tz", c.tz);
        card.setAttribute("data-label", c.label);

        card.innerHTML = `
          <div class="top">
            <div class="city">
              <span class="badge">${escapeHtml(c.flag || "üåê")}</span>
              <span>${escapeHtml(c.label)}</span>
            </div>
            <div class="pill" style="opacity:.95">
              <span class="sunmoon" data-sunmoon="${tzEsc}">‚è≥</span>
              <span data-tzname="${tzEsc}">---</span>
            </div>
          </div>

          <div class="mid">
            <div class="row" aria-label="12 hour clock (slide)">
              ${digitTemplate(c.tz,0)}
              ${digitTemplate(c.tz,1)}
              <div class="colon blink">:</div>
              ${digitTemplate(c.tz,2)}
              ${digitTemplate(c.tz,3)}
              <div class="colon blink">:</div>
              ${digitTemplate(c.tz,4)}
              ${digitTemplate(c.tz,5)}
              <div class="ampm" data-ampm="${tzEsc}">--</div>
            </div>
            <!-- Under flip: 24h text -->
            <div class="time12" data-tz12="${tzEsc}">--:--</div>
          </div>

          <div class="meta">
            <div class="pill" data-date="${tzEsc}">---</div>
            <div class="pill wxPill" data-wx="${escapeHtml(c.tz)}|${escapeHtml(c.label)}">
              <span class="wxIcon">üå°Ô∏è</span>
              <span class="wxTemp">--</span>
              <span class="wxNote">Loading</span>
            </div>
          </div>
        `;
        grid.appendChild(card);
      }
    }

    function setDigit(boxEl, newVal){
      const tz = boxEl.getAttribute("data-tz");
      const pos = boxEl.getAttribute("data-pos");
      const key = `${tz}|${pos}`;
      const oldVal = digitState.get(key);
      if (oldVal === newVal) return;

      const stack = boxEl.querySelector("[data-stack]");
      const h = boxEl.getBoundingClientRect().height;
      stack.style.transform = `translate3d(0, ${-newVal * h}px, 0)`;
      digitState.set(key, newVal);
    }

    function tick(){
      const d = new Date();
      const header = new Intl.DateTimeFormat(undefined, {
        weekday:"short", month:"short", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit",
        hour12:false
      }).format(d);
      localNow.textContent = `Local (24h): ${header}`;

      // Update only visible cards
      document.querySelectorAll(".digitBox").forEach(box => {
        const tz = box.getAttribute("data-tz");
        const pos = Number(box.getAttribute("data-pos"));
        const digits = time12Digits(tz);
        const n = Number(digits[pos] || "0");
        setDigit(box, n);
      });

      document.querySelectorAll("[data-ampm]").forEach(el => {
        el.textContent = ampmOnly(el.getAttribute("data-ampm"));
      });

      // Under flip: 24h text
      document.querySelectorAll("[data-tz12]").forEach(el => {
        el.textContent = fmtTime24(el.getAttribute("data-tz12"));
      });

      document.querySelectorAll("[data-date]").forEach(el => {
        el.textContent = fmtDate(el.getAttribute("data-date"));
      });

      document.querySelectorAll("[data-tzname]").forEach(el => {
        el.textContent = tzShortName(el.getAttribute("data-tzname"));
      });

      document.querySelectorAll("[data-sunmoon]").forEach(el => {
        const tz = el.getAttribute("data-sunmoon");
        el.textContent = sunOrMoonEmoji(tzHour(tz));
      });
    }

    function startRotation(){
      setInterval(() => {
        grid.classList.add("fading");
        setTimeout(() => {
          pageIndex++;
          buildPage();
          tick();
          refreshVisibleWeather();
          grid.classList.remove("fading");
        }, 360);
      }, ROTATE_MS);
    }

    // Initial render
    buildPage();
    tick();
    setInterval(tick, 1000);

    // Weather: refresh current page now + every 15 min
    refreshVisibleWeather();
    setInterval(refreshVisibleWeather, WEATHER_REFRESH_MS);

    // Rotate pages
    startRotation();

    // Resize rebuild
    window.addEventListener("resize", (() => {
      let t;
      return () => {
        clearTimeout(t);
        t = setTimeout(() => {
          buildPage();
          tick();
          refreshVisibleWeather();
        }, 200);
      };
    })());
  </script>
</body>
</html>
